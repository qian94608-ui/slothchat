<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F9F4EF">
    <title>Pepeå¿«ä¼ </title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¸</text></svg>">
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root {
            --bg-color: #F9F4EF; 
            --surface-solid: #FFFFFF;
            --primary: #4A90E2; --primary-soft: #E8F0FE; /* è°ƒæ•´ä¸ºæ›´æ¸…çˆ½çš„è“ */
            --pepe-green: #56ab2f;
            --text-main: #2D3748; --text-sub: #718096;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.02);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --radius-L: 18px; --radius-M: 12px;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* 5. å¼ºåˆ¶ Emoji å­—ä½“æ”¯æŒ */
        body { 
            margin: 0; 
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; 
            background: var(--bg-color); 
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden; 
            color: var(--text-main); -webkit-font-smoothing: antialiased; 
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        .icon { width: 22px; height: 22px; fill: currentColor; stroke-width: 2; }

        /* å¯¼èˆªæ  */
        .navbar { height: 56px; padding: 0 20px; background: rgba(249, 244, 239, 0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; z-index: 50; flex-shrink: 0; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .brand { display: flex; align-items: center; gap: 12px; }
        /* 7. Pepe Icon å®¹å™¨ */
        .logo-box { width: 36px; height: 36px; border-radius: 50%; background: #e0eacc; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); border: 2px solid white; }
        .app-logo { width: 100%; height: 100%; object-fit: cover; }
        .app-name { font-size: 17px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
        .status-pill { font-size: 11px; padding: 4px 10px; border-radius: 12px; background: rgba(0,0,0,0.04); color: var(--text-sub); font-weight: 600; }
        .status-pill.online { background: #C6F6D5; color: #22543D; }

        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; padding-bottom: 70px; }

        /* æ‹–æ‹½ */
        .drag-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 999; display: none; flex-direction: column; align-items: center; justify-content: center; color: var(--primary); backdrop-filter: blur(5px); }
        .drag-overlay.active { display: flex; animation: fadeIn 0.2s; }

        /* æŠ•é€’åŒº */
        .drop-zone-wrapper { padding: 12px 16px 0 16px; flex-shrink: 0; }
        .drop-card { height: 80px; background: var(--surface-solid); border-radius: var(--radius-L); border: 1px dashed #CBD5E0; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: var(--primary); transition: all 0.2s; }
        .drop-card:active { background: var(--primary-soft); border-color: var(--primary); }
        .drop-label { font-size: 13px; font-weight: 600; color: var(--text-sub); margin-top: 4px; }

        /* èŠå¤©åˆ—è¡¨ */
        .chat-scroll { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 14px; scroll-behavior: smooth; }
        .sys-notice { text-align: center; font-size: 12px; color: var(--text-sub); opacity: 0.6; margin: 8px 0; }

        /* æ¶ˆæ¯æ°”æ³¡ */
        .msg-row { display: flex; width: 100%; margin-bottom: 2px; }
        .msg-row.self { justify-content: flex-end; } .msg-row.peer { justify-content: flex-start; }
        .bubble { max-width: 85%; padding: 10px 14px; border-radius: var(--radius-M); font-size: 15px; line-height: 1.5; box-shadow: var(--shadow-sm); word-break: break-word; }
        .msg-row.self .bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg-row.peer .bubble { background: var(--surface-solid); color: var(--text-main); border-bottom-left-radius: 4px; }

        /* æ–‡ä»¶å¡ç‰‡ (æ ¸å¿ƒä¿®æ”¹) */
        .file-card { width: 230px; position: relative; }
        .file-inner { 
            background: var(--surface-solid); border-radius: 14px; padding: 8px; 
            display: flex; align-items: center; gap: 10px; cursor: pointer; 
            transition: background 0.2s; border: 1px solid rgba(0,0,0,0.03);
        }
        .msg-row.self .file-inner { background: rgba(255,255,255,0.9); }
        
        /* 1. é¢„è§ˆå›¾ä¼˜åŒ–ï¼šç¼©å°50%ï¼Œå¼ºåˆ¶ä¸æº¢å‡º */
        .thumb-box { 
            width: 40px; height: 40px; /* å›ºå®šå°å°ºå¯¸ */
            border-radius: 10px; background: #EDF2F7; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; flex-shrink: 0; font-size: 18px;
            position: relative;
        }
        .thumb-img { 
            width: 100%; height: 100%; 
            object-fit: cover; /* å¼ºåˆ¶å¡«æ»¡è£å‰ª */
            display: block; 
        }

        /* 4. è¯­éŸ³æ³¢çº¹ç‰¹æ•ˆ */
        .voice-wave { display: none; align-items: center; gap: 3px; height: 16px; }
        .voice-wave.playing { display: flex; }
        .voice-bar { width: 3px; background: var(--primary); border-radius: 2px; animation: wave 0.8s infinite ease-in-out; }
        .voice-bar:nth-child(1) { animation-delay: 0s; height: 6px; }
        .voice-bar:nth-child(2) { animation-delay: 0.1s; height: 10px; }
        .voice-bar:nth-child(3) { animation-delay: 0.2s; height: 14px; }
        .voice-bar:nth-child(4) { animation-delay: 0.1s; height: 8px; }
        @keyframes wave { 0%,100%{height:4px} 50%{height:14px} }
        /* å‘é€æ–¹æ³¢çº¹é¢œè‰²é€‚é… */
        .msg-row.self .voice-bar { background: var(--text-main); } 

        .file-info { flex: 1; overflow: hidden; min-width: 0; }
        .file-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-main); }
        .file-meta { font-size: 11px; color: var(--text-sub); margin-top: 2px; display: flex; justify-content: space-between; font-weight: 500; }
        
        .progress-bar { height: 3px; background: #EDF2F7; margin-top: 6px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #48BB78; transition: width 0.1s linear; } /* 6. å®æ—¶è¿›åº¦åŠ¨ç”»æ›´å¹³æ»‘ */

        .btn-preview { width: 32px; height: 32px; border-radius: 50%; background: white; color: var(--text-main); border: none; position: absolute; right: -8px; bottom: -8px; display: none; align-items: center; justify-content: center; box-shadow: var(--shadow-md); cursor: pointer; z-index: 10; font-size: 14px; }

        /* åº•éƒ¨è¾“å…¥ */
        .input-area-wrapper { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); padding: 8px 16px; padding-bottom: max(8px, var(--safe-bottom)); z-index: 100; border-top: 1px solid rgba(0,0,0,0.05); }
        .input-bar { display: flex; align-items: center; gap: 10px; height: 44px; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; color: var(--text-sub); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .btn-voice { flex: 1; height: 40px; border-radius: 20px; border: none; background: #EDF2F7; color: var(--text-main); font-weight: 600; font-size: 15px; }
        .btn-voice.recording { background: #FC8181; color: white; animation: pulse 1s infinite; }
        #msg-input { flex: 1; height: 40px; padding: 0 16px; border-radius: 20px; background: #EDF2F7; border: 1px solid transparent; outline: none; font-size: 16px; display: none; color: var(--text-main); }

        /* å¼¹çª— & å…¶ä»– */
        .modal { position: fixed; inset: 0; background: rgba(249, 244, 239, 0.95); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .card { width: 86%; max-width: 340px; background: white; padding: 30px 24px; border-radius: 28px; text-align: center; box-shadow: var(--shadow-lg); }
        .pepe-head { font-size: 80px; margin-bottom: 10px; animation: bounce 2s infinite; display: inline-block; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        .input-id { width: 100%; height: 46px; border-radius: 14px; border: 2px solid #EDF2F7; text-align: center; font-size: 18px; font-weight: 700; margin-bottom: 20px; outline: none; background: #F7FAFC; color: var(--primary); letter-spacing: 2px; }
        .input-id:focus { border-color: var(--primary); background: white; }
        .btn-block { width: 100%; height: 48px; border-radius: 14px; background: var(--primary); color: white; border: none; font-weight: 700; font-size: 16px; cursor: pointer; }
        
        .lightbox { position: fixed; inset: 0; background: black; z-index: 5000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .lightbox.active { display: flex; opacity: 1; }
        .lightbox-content { max-width: 100%; max-height: 100%; object-fit: contain; }
        .btn-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.3); width: 40px; height: 40px; border-radius: 50%; border:none; color:white; font-size:24px; z-index: 5001; }
        #toast { position: fixed; top: 12px; left: 50%; transform: translateX(-50%) translateY(-20px); background: #2D3748; color: white; padding: 8px 20px; border-radius: 30px; font-size: 14px; font-weight: 600; z-index: 6000; opacity: 0; transition: all 0.3s; pointer-events: none; }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="lightbox" id="lightbox" onclick="triggerClose()">
        <button class="btn-close">Ã—</button>
        <img id="lb-img" class="lightbox-content" style="display:none">
        <video id="lb-video" class="lightbox-content" controls style="display:none" onclick="event.stopPropagation()"></video>
    </div>

    <div class="modal" id="modal">
        <div class="card">
            <div class="pepe-head">ğŸ¸</div>
            <h2 style="margin:0 0 20px 0; font-size:20px; color:var(--text-main)">Pepeå¿«ä¼ </h2>
            <div id="qr-code" style="margin-bottom:20px; padding:8px; background:white; border-radius:12px; display:inline-block;"></div>
            <div style="font-size:14px; color:var(--text-sub); margin-bottom:8px;">æˆ‘çš„ ID</div>
            <div id="my-id" style="font-size:24px; font-weight:800; color:var(--primary); margin-bottom:20px; letter-spacing:1px;">...</div>
            <input type="text" id="target-id" class="input-id" placeholder="è¾“å…¥å¯¹æ–¹ ID">
            <div id="scanner-box" style="display:none; height:200px; background:black; border-radius:14px; margin-bottom:15px; overflow:hidden;"><div id="reader"></div></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-block" style="background:#EDF2F7; color:#2D3748; flex:1" onclick="toggleScan()">ğŸ“·</button>
                <button class="btn-block" style="flex:2" onclick="connect()">è¿æ¥</button>
            </div>
        </div>
    </div>

    <div class="navbar">
        <div class="brand">
            <div class="logo-box">
                <svg viewBox="0 0 100 100" style="width:100%;height:100%"><text y="68" x="50" text-anchor="middle" font-size="70">ğŸ¸</text></svg>
            </div>
            <span class="app-name">Pepeå¿«ä¼ </span>
        </div>
        <div class="status-pill" id="status">ç¦»çº¿</div>
    </div>

    <div class="main-container">
        <div class="drag-overlay" id="drag-overlay">
            <div style="font-size:60px; margin-bottom:20px;">ğŸ“‚</div>
            <div>æ¾æ‰‹ å‘é€æ–‡ä»¶</div>
        </div>

        <div class="drop-zone-wrapper">
            <div class="drop-card" id="drop-zone">
                <span style="font-size:24px; margin-bottom:6px">ğŸ“¤</span>
                <span class="drop-label">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶</span>
            </div>
        </div>
        <div class="chat-scroll" id="chat-list">
            <div class="sys-notice">Pepe V3.0 - ä¿®å¤é¢„è§ˆä¸ç‰¹æ•ˆç‰ˆ</div>
        </div>
    </div>

    <div class="input-area-wrapper">
        <div class="input-bar">
            <button class="btn-circle" onclick="toggleInput()">âŒ¨ï¸</button>
            <button id="btn-voice" class="btn-voice">æŒ‰ä½ è¯´è¯</button>
            <input id="msg-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
            <button class="btn-circle" onclick="sendText()" id="btn-send" style="display:none; color:var(--primary);">â¤</button>
        </div>
    </div>
    <input type="file" id="file-input" multiple style="display:none">

    <script>
        const App = { id: null, peer: null, conn: null, connected: false, queue: [], isSending: false };
        document.addEventListener('DOMContentLoaded', () => setTimeout(init, 100));

        function showToast(msg, type='normal') {
            const t = document.getElementById('toast');
            t.innerText = msg; t.className = 'show';
            t.style.background = type === 'error' ? '#E53E3E' : '#2D3748';
            setTimeout(() => t.className = '', 2500);
        }

        function init() {
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});

            // 6ä½æ•° ID
            App.id = localStorage.getItem('pepe_id') || (Math.floor(Math.random()*900000)+100000).toString();
            localStorage.setItem('pepe_id', App.id);
            document.getElementById('my-id').innerText = App.id;
            const qr = document.getElementById("qr-code");
            if(qr && window.QRCode) new QRCode(qr, { text: App.id, width: 120, height: 120, colorDark: "#2D3748", colorLight: "#FFFFFF", correctLevel: QRCode.CorrectLevel.L });

            if(window.Peer) {
                App.peer = new Peer(App.id, { 
                    config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } 
                });
                App.peer.on('open', () => document.getElementById('status').innerText='ç­‰å¾…è¿æ¥');
                App.peer.on('connection', c => { if(confirm('æ˜¯å¦æ¥å— ID: '+c.peer+' çš„è¿æ¥?')) setupConn(c); });
                App.peer.on('error', () => document.getElementById('status').innerText='ç½‘ç»œé”™è¯¯');
                setInterval(() => { if(App.conn && App.conn.open) App.conn.send({type:'ping'}); }, 10000);
            }
        }

        function setupConn(conn) {
            if(App.conn) App.conn.close(); App.conn = conn;
            conn.on('open', () => {
                conn.send({ type: 'handshake' });
                App.connected=true; document.getElementById('modal').style.display='none';
                document.getElementById('status').innerText='å·²è¿æ¥'; document.getElementById('status').classList.add('online');
            });
            conn.on('data', handleData);
            conn.on('close', () => { App.connected=false; document.getElementById('status').innerText='å·²æ–­å¼€'; showToast('å¯¹æ–¹å·²æ–­å¼€','error'); });
        }
        function connect() { const t=document.getElementById('target-id').value.trim(); if(t) setupConn(App.peer.connect(t)); }

        // 6. æ¥æ”¶ç«¯é€»è¾‘ä¼˜åŒ–ï¼šæ›´é¢‘ç¹æ›´æ–°
        let Rx = { buf: [], size: 0, meta: null, lastLoaded: 0, lastTime: 0 };
        function handleData(data) {
            if (data.type) {
                if(data.type==='handshake'){ App.connected=true; document.getElementById('modal').style.display='none'; document.getElementById('status').innerText='å·²è¿æ¥'; document.getElementById('status').classList.add('online'); }
                else if(data.type==='text') addMsg(data.text, 'peer');
                else if(data.type==='file-start') { Rx={buf:[],size:0,meta:data,lastLoaded:0,lastTime:Date.now()}; createFileItem(data.id, data.name, data.size, 'peer', data.mime); }
                else if(data.type==='file-end') finishFile(data.id, Rx.meta.mime); // æ¥æ”¶ç«¯å®Œæˆ
            } else {
                Rx.buf.push(data); Rx.size += data.byteLength;
                const now = Date.now();
                // 6. æé«˜åˆ·æ–°é¢‘ç‡åˆ° 50ms
                if(now - Rx.lastTime > 50) {
                    const speed = calcSpeed(Rx.size - Rx.lastLoaded, now - Rx.lastTime);
                    updateProgress(Rx.meta.id, Rx.size, Rx.meta.size, speed);
                    Rx.lastLoaded = Rx.size; Rx.lastTime = now;
                }
            }
        }
        function calcSpeed(bytes, ms) { return ms<=0?'':(bytes/ms*1000 > 1048576 ? (bytes/ms*1000/1048576).toFixed(1)+' MB/s' : (bytes/ms*1000/1024).toFixed(0)+' KB/s'); }

        // æ‹–æ‹½ä¸æ–‡ä»¶
        const dragOverlay = document.getElementById('drag-overlay');
        document.addEventListener('dragenter', e => { e.preventDefault(); dragOverlay.classList.add('active'); });
        document.addEventListener('dragleave', e => { e.preventDefault(); if(e.relatedTarget===null) dragOverlay.classList.remove('active'); });
        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', e => { e.preventDefault(); dragOverlay.classList.remove('active'); if(e.dataTransfer.files.length) enqueue(e.dataTransfer.files); });
        
        document.getElementById('drop-zone').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = e => enqueue(e.target.files);

        function enqueue(files) {
            if(!App.connected) return showToast('è¯·å…ˆè¿æ¥', 'error');
            Array.from(files).forEach(f => { 
                const id = 'f-'+Date.now()+Math.random().toString(36).substr(2); 
                createFileItem(id, f.name, f.size, 'self', f.type); // åˆ›å»ºUI
                App.queue.push({f, id}); 
            });
            process();
        }
        function process() { if(App.isSending || !App.queue.length) return; App.isSending=true; sendFile(App.queue.shift()); }
        
        function sendFile({f, id}) {
            App.conn.send({type:'file-start', id, name:f.name, size:f.size, mime:f.type});
            const reader = new FileReader(); let offset=0; let lastTime=Date.now(); let lastLoaded=0;
            const push = () => { 
                if(App.conn.dataChannel.bufferedAmount > 65536) { setTimeout(push, 10); return; } 
                const s = f.slice(offset, offset + 16384); reader.readAsArrayBuffer(s); 
            };
            reader.onload = e => {
                App.conn.send(e.target.result); offset += e.target.result.byteLength;
                const now = Date.now();
                if(now - lastTime > 50 || offset >= f.size) { // 6. å‘é€ç«¯ä¹Ÿæé«˜åˆ·æ–°é¢‘ç‡
                    const speed = calcSpeed(offset - lastLoaded, now - lastTime);
                    updateProgress(id, offset, f.size, speed);
                    lastLoaded = offset; lastTime = now;
                }
                if(offset < f.size) setTimeout(push, 0); 
                else { 
                    App.conn.send({type:'file-end', id}); 
                    App.isSending=false; 
                    // 3. å‘é€ç«¯ä¹Ÿè°ƒç”¨ finishFile ä»¥ç”Ÿæˆé¢„è§ˆï¼Œç¡®ä¿ self å’Œ peer é€»è¾‘ä¸€è‡´
                    // æ³¨æ„ï¼šå‘é€ç«¯ä¸éœ€è¦ Blob (å› ä¸ºæœ¬åœ°æœ‰æ–‡ä»¶)ï¼Œä½†ä¸ºäº†é¢„è§ˆå›¾ï¼Œè¿™é‡Œå¯ä»¥ç®€å•å¤„ç†
                    // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬åªåš UI æ›´æ–°ï¼Œé¢„è§ˆå›¾åœ¨ createFileItem æ—¶æ²¡æœ‰ç”Ÿæˆï¼Œéœ€è¦åœ¨è¿™é‡Œè¡¥æ•‘ï¼Ÿ
                    // å®é™…ä¸Šå‘é€ç«¯ç›´æ¥è¯»å–åŸæ–‡ä»¶ç”Ÿæˆé¢„è§ˆæœ€å¥½ã€‚
                    finishFile(id, f.type, f); // ä¼ å…¥åŸæ–‡ä»¶å¯¹è±¡
                    setTimeout(process, 50); 
                }
            };
            push();
        }

        function createFileItem(id, name, size, who, mime) {
            const div = document.createElement('div'); div.className = `msg-row ${who}`; div.id = `msg-${id}`;
            const isImg = mime.startsWith('image/');
            const icon = isImg ? 'ğŸ–¼ï¸' : (mime.startsWith('video/')?'ğŸ¬':(mime.startsWith('audio/')?'ğŸµ':'ğŸ“„'));
            
            div.innerHTML = `
                <div class="file-card">
                    <div class="file-inner">
                        <div class="thumb-box">${icon}</div>
                        <div class="file-info">
                            <div class="file-name">${name}</div>
                            <div class="file-meta">
                                <span>${(size/1024).toFixed(1)} KB</span> 
                                <span class="speed-tag">ç­‰å¾…...</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill"></div></div>
                        </div>
                        <button class="btn-preview">ğŸ‘ï¸</button>
                    </div>
                </div>`;
            document.getElementById('chat-list').append(div);
            document.getElementById('chat-list').scrollTop = 99999;
        }

        function updateProgress(id, cur, tot, speed) {
            const el = document.getElementById(`msg-${id}`);
            if(el) { 
                el.querySelector('.progress-fill').style.width = (cur/tot*100)+'%'; 
                el.querySelector('.speed-tag').innerText = speed; 
            }
        }

        // æ ¸å¿ƒä¿®æ”¹ï¼šç»Ÿä¸€å¤„ç†æ–‡ä»¶å®Œæˆé€»è¾‘
        // fileObj å‚æ•°ä»…å‘é€ç«¯æœ‰ï¼Œæ¥æ”¶ç«¯ä¸º undefined (éœ€ä» Rx.buf ç”Ÿæˆ)
        function finishFile(id, mime, fileObj) {
            const el = document.getElementById(`msg-${id}`); if(!el) return;
            el.querySelector('.progress-bar').style.display='none'; 
            el.querySelector('.speed-tag').innerText='å®Œæˆ';

            let url;
            // 3. æ¥æ”¶ç«¯ç”Ÿæˆ URLï¼Œå‘é€ç«¯å¦‚æœä¼ äº† fileObj ä¹Ÿç”Ÿæˆ URL ç”¨äºé¢„è§ˆ
            if (fileObj) {
                url = URL.createObjectURL(fileObj);
            } else {
                // æ¥æ”¶ç«¯ï¼šä» buffer ç”Ÿæˆ
                if(Rx.buf.length === 0) return; // é˜²æ­¢ç©ºè°ƒç”¨
                url = URL.createObjectURL(new Blob(Rx.buf, {type: mime}));
                Rx.buf = []; // æ¸…ç©ºç¼“å­˜
            }

            // 3. ä¿®å¤æ–‡ä»¶åè·å–ï¼šæ¥æ”¶ç«¯ç”¨ Rx.metaï¼Œå‘é€ç«¯ç›´æ¥ä» DOM è¯»
            const nameEl = el.querySelector('.file-name');
            const filename = (Rx && Rx.meta && Rx.meta.id === id) ? Rx.meta.name : nameEl.innerText;
            
            const inner = el.querySelector('.file-inner');
            const thumbBox = el.querySelector('.thumb-box');
            const btnPreview = el.querySelector('.btn-preview');

            // é»˜è®¤è¡Œä¸ºï¼šç‚¹å‡»ä¸‹è½½
            const download = () => { const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); };
            inner.onclick = download;

            // 2. å‘é€ç«¯å’Œæ¥æ”¶ç«¯ç°åœ¨éƒ½èƒ½ç”Ÿæˆé¢„è§ˆå›¾äº†
            if (mime.includes('image')) {
                // 1. CSS å·²é™åˆ¶ .thumb-img çš„å¤§å°
                thumbBox.innerHTML = `<img src="${url}" class="thumb-img">`; 
                btnPreview.style.display = 'flex';
                btnPreview.onclick = (e) => { e.stopPropagation(); openLightbox(url, 'img'); };
            } 
            else if (mime.includes('video')) {
                const video = document.createElement('video'); video.src = url; video.currentTime = 0.5; video.className = 'thumb-img';
                thumbBox.innerHTML = ''; thumbBox.appendChild(video);
                btnPreview.innerHTML = 'â–¶'; btnPreview.style.display = 'flex';
                btnPreview.onclick = (e) => { e.stopPropagation(); openLightbox(url, 'video'); };
            }
            // 4. è¯­éŸ³æ’­æ”¾é€»è¾‘ + åŠ¨æ€ç‰¹æ•ˆ
            else if (mime.includes('audio')) {
                // æ›¿æ¢é™æ€å›¾æ ‡ä¸ºæ³¢çº¹ç»“æ„
                thumbBox.innerHTML = `
                    <div class="voice-wave">
                        <div class="voice-bar"></div><div class="voice-bar"></div>
                        <div class="voice-bar"></div><div class="voice-bar"></div>
                    </div>`;
                
                const wave = thumbBox.querySelector('.voice-wave');
                const audio = new Audio(url); 
                let isPlaying = false;

                // è¦†ç›–ç‚¹å‡»äº‹ä»¶ï¼šæ’­æ”¾/æš‚åœ
                inner.onclick = (e) => {
                    e.stopPropagation();
                    if(isPlaying) {
                        audio.pause();
                        wave.classList.remove('playing');
                        nameEl.style.color = 'var(--text-main)';
                    } else {
                        audio.play();
                        wave.classList.add('playing'); // è§¦å‘ CSS åŠ¨ç”»
                        nameEl.style.color = 'var(--primary)';
                    }
                    isPlaying = !isPlaying;
                };

                audio.onended = () => {
                    isPlaying = false;
                    wave.classList.remove('playing');
                    nameEl.style.color = 'var(--text-main)';
                };
            }
        }

        function openLightbox(url, type) {
            const lb=document.getElementById('lightbox'), img=document.getElementById('lb-img'), vid=document.getElementById('lb-video');
            img.style.display='none'; vid.style.display='none';
            lb.classList.add('active');
            if(type==='img') { img.src=url; img.style.display='block'; }
            else if(type==='video') { vid.src=url; vid.style.display='block'; vid.play(); }
        }
        window.triggerClose = () => {
            document.getElementById('lightbox').classList.remove('active');
            document.getElementById('lb-video').pause();
        };

        // è¯­éŸ³å½•åˆ¶
        const bVoice=document.getElementById('btn-voice'); let mRec, chunks=[];
        const startR=async e=>{
            e.preventDefault(); if(!App.connected) return showToast('æœªè¿æ¥','error');
            try {
                const s=await navigator.mediaDevices.getUserMedia({audio:true});
                mRec=new MediaRecorder(s); chunks=[];
                mRec.ondataavailable=e=>chunks.push(e.data);
                mRec.onstop=()=>enqueue([new File([new Blob(chunks)],"è¯­éŸ³æ¶ˆæ¯.webm",{type:'audio/webm'})]);
                mRec.start(); bVoice.classList.add('recording'); bVoice.innerText="æ¾å¼€ å‘é€";
            } catch(e){ showToast("æ— æ³•è®¿é—®éº¦å…‹é£",'error'); }
        };
        const stopR=e=>{ e.preventDefault(); if(mRec && mRec.state!=='inactive') mRec.stop(); bVoice.classList.remove('recording'); bVoice.innerText="æŒ‰ä½ è¯´è¯"; };
        ['touchstart','mousedown'].forEach(k=>bVoice.addEventListener(k,startR)); 
        ['touchend','mouseup'].forEach(k=>bVoice.addEventListener(k,stopR));
        
        // 5. è¡¨æƒ…å’Œæ–‡æœ¬å‘é€
        window.toggleInput=()=>{
            const t=document.getElementById('msg-input'), v=document.getElementById('btn-voice'), s=document.getElementById('btn-send');
            const show = t.style.display==='none';
            t.style.display = show?'block':'none';
            v.style.display = show?'none':'block';
            s.style.display = show?'block':'none';
            if(show) t.focus();
        };
        window.sendText=()=>{
            const v=document.getElementById('msg-input').value;
            if(v){ App.conn.send({type:'text',text:v}); addMsg(v,'self'); document.getElementById('msg-input').value=''; }
        };
        function addMsg(t,w){
            const d=document.createElement('div'); d.className=`msg-row ${w}`;
            d.innerHTML=`<div class="bubble">${t}</div>`;
            document.getElementById('chat-list').append(d);
            document.getElementById('chat-list').scrollTop=99999;
        }
        
        let qr; window.toggleScan=()=>{
            const s=document.getElementById('scanner-box');
            if(s.style.display==='block'){ s.style.display='none'; if(qr) qr.stop(); }
            else { s.style.display='block'; qr=new Html5Qrcode("reader"); qr.start({facingMode:"environment"},{fps:10},t=>{document.getElementById('target-id').value=t;toggleScan();}); }
        };
    </script>
</body>
</html>
