<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F9F4EF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>é—ªç”µå¿«ä¼ </title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="./sloth.png">
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root {
            --bg-color: #F9F4EF; 
            --surface-solid: #FFFFFF;
            --primary: #2B6CB0; --primary-soft: #EBF8FF;
            --text-main: #2D3748; --text-sub: #718096;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.02);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.08);
            --radius-L: 20px; --radius-M: 14px;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; background: var(--bg-color); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; color: var(--text-main); -webkit-font-smoothing: antialiased; }
        .icon { width: 22px; height: 22px; fill: currentColor; stroke-width: 2; }

        /* å¯¼èˆªæ  */
        .navbar { height: 56px; padding: 0 20px; background: rgba(249, 244, 239, 0.85); backdrop-filter: blur(16px); display: flex; justify-content: space-between; align-items: center; z-index: 50; flex-shrink: 0; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo-box { width: 32px; height: 32px; border-radius: 50%; background: transparent; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); }
        .app-logo { width: 100%; height: 100%; object-fit: cover; }
        .app-name { font-size: 16px; font-weight: 700; color: var(--text-main); }
        .status-pill { font-size: 11px; padding: 4px 10px; border-radius: 12px; background: rgba(0,0,0,0.04); color: var(--text-sub); font-weight: 600; }
        .status-pill.online { background: #C6F6D5; color: #22543D; }

        /* ä¸»å®¹å™¨ */
        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; padding-bottom: 70px; }

        /* æ‹–æ‹½é®ç½© */
        .drag-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.85); z-index: 999; display: none; flex-direction: column; align-items: center; justify-content: center; color: var(--primary); backdrop-filter: blur(8px); pointer-events: none; }
        .drag-overlay.active { display: flex; animation: fadeIn 0.2s; }

        /* æŠ•é€’å¡ç‰‡ */
        .drop-zone-wrapper { padding: 16px 20px 0 20px; flex-shrink: 0; }
        .drop-card { height: 90px; background: var(--surface-solid); border-radius: var(--radius-L); border: 1px solid rgba(0,0,0,0.06); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: var(--primary); box-shadow: var(--shadow-sm); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .drop-card:active { transform: scale(0.98); background: var(--primary-soft); }
        .drop-card.drag-active { border: 2px solid var(--primary); background: var(--primary-soft); box-shadow: var(--shadow-md); transform: scale(1.02); }
        .drop-label { font-size: 13px; font-weight: 600; color: var(--text-sub); margin-top: 6px; }

        /* èŠå¤©åŒº */
        .chat-scroll { flex: 1; padding: 16px 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
        .sys-notice { text-align: center; font-size: 12px; color: var(--text-sub); opacity: 0.6; margin: 10px 0; font-weight: 500; }

        /* æ¶ˆæ¯æ°”æ³¡ (æ–‡æœ¬) */
        .msg-row { display: flex; width: 100%; margin-bottom: 2px; }
        .msg-row.self { justify-content: flex-end; } .msg-row.peer { justify-content: flex-start; }
        .bubble { max-width: 85%; padding: 10px 14px; border-radius: var(--radius-M); font-size: 15px; line-height: 1.5; box-shadow: var(--shadow-sm); }
        /* æ–‡æœ¬æ°”æ³¡ä¿æŒè“è‰² */
        .msg-row.self .bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg-row.peer .bubble { background: var(--surface-solid); color: var(--text-main); border-bottom-left-radius: 4px; }

        /* æ–‡ä»¶å¡ç‰‡ (V22 é‡ç‚¹ä¼˜åŒ–) */
        .file-card { width: 240px; position: relative; }
        .file-inner { 
            background: var(--surface-solid); border-radius: 12px; padding: 10px; 
            display: flex; align-items: center; gap: 12px; cursor: pointer; 
            transition: background 0.2s;
        }
        
        /* [V22 ä¿®å¤] å‘é€æ–¹æ–‡ä»¶å¡ç‰‡ï¼šæµ…ç°èƒŒæ™¯ + æ·±è‰²æ–‡å­— */
        .msg-row.self .file-inner { 
            background: rgba(0, 0, 0, 0.05); /* æµ…ç°åŠé€æ˜ï¼Œå¯¹æ¯”æš–é»„èƒŒæ™¯ */
            border: 1px solid rgba(0, 0, 0, 0.05); 
        }
        
        .thumb-box { width: 44px; height: 44px; border-radius: 10px; background: #EDF2F7; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }
        /* å‘é€æ–¹å›¾æ ‡èƒŒæ™¯ä¹Ÿè°ƒæš—ä¸€ç‚¹ï¼Œé€‚é…æµ…ç°å¡ç‰‡ */
        .msg-row.self .thumb-box { background: rgba(255, 255, 255, 0.5); color: var(--primary); }

        .file-info { flex: 1; overflow: hidden; }
        .file-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 11px; opacity: 0.7; margin-top: 3px; display: flex; justify-content: space-between; font-weight: 500; }
        
        /* [V22 ä¿®å¤] å‘é€æ–¹æ–‡å­—é¢œè‰²æ”¹ä¸ºæ·±è‰² */
        .msg-row.self .file-name { color: var(--text-main); text-shadow: none; }
        .msg-row.self .file-meta { color: var(--text-sub); }
        
        .progress-bar { height: 3px; background: rgba(0,0,0,0.06); margin-top: 8px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.2s; }
        .msg-row.self .progress-fill { background: var(--primary); } /* è¿›åº¦æ¡ä¿æŒè“è‰² */

        .btn-preview { width: 34px; height: 34px; border-radius: 50%; background: var(--surface-solid); color: var(--primary); border: none; position: absolute; right: -10px; bottom: -10px; display: none; align-items: center; justify-content: center; box-shadow: var(--shadow-md); cursor: pointer; z-index: 10; transition: transform 0.2s; }
        .btn-preview:active { transform: scale(0.9); }

        /* åº•éƒ¨æ  */
        .input-area-wrapper { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); padding: 10px 16px; padding-bottom: max(10px, var(--safe-bottom)); z-index: 100; box-shadow: 0 -1px 0 rgba(0,0,0,0.05); }
        .input-bar { display: flex; align-items: center; gap: 10px; height: 44px; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; color: var(--text-sub); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
        .btn-circle:active { background: rgba(0,0,0,0.05); }
        .btn-voice { flex: 1; height: 42px; border-radius: 21px; border: none; background: #EDF2F7; color: var(--text-main); font-weight: 600; font-size: 15px; transition: 0.2s; }
        .btn-voice:active { background: #E2E8F0; }
        .btn-voice.recording { background: #FC8181; color: white; animation: pulse 1.5s infinite; }
        #msg-input { flex: 1; height: 42px; padding: 0 18px; border-radius: 21px; background: #EDF2F7; border: 1px solid transparent; outline: none; font-size: 16px; display: none; min-width: 0; color: var(--text-main); }
        #msg-input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(43, 108, 176, 0.1); }

        /* å¼¹çª— */
        .modal { position: fixed; inset: 0; background: rgba(249, 244, 239, 0.95); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .card { width: 86%; max-width: 360px; background: var(--surface-solid); padding: 36px 28px; border-radius: 32px; text-align: center; box-shadow: var(--shadow-lg); }
        .hero-crop { width: 100px; height: 100px; margin: 0 auto 20px auto; border-radius: 50%; background: transparent; box-shadow: var(--shadow-md); overflow: hidden; animation: float 4s ease-in-out infinite; }
        .hero-img { width: 100%; height: 100%; object-fit: cover; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
        .id-display { background: #EDF2F7; padding: 12px; border-radius: 12px; margin: 16px 0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-weight: 700; font-size: 18px; letter-spacing: 1px; color: var(--primary); }
        .input-id { width: 100%; height: 48px; border-radius: 16px; border: 2px solid #EDF2F7; text-align: center; font-size: 16px; font-weight: 600; margin-bottom: 20px; outline: none; transition: 0.2s; background: #F7FAFC; }
        .input-id:focus { border-color: var(--primary); background: white; }
        .btn-block { width: 100%; height: 50px; border-radius: 16px; background: var(--primary); color: white; border: none; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 4px 12px rgba(43, 108, 176, 0.2); transition: 0.2s; }
        .btn-block:active { transform: scale(0.98); }
        .btn-ghost { background: #EDF2F7; color: var(--text-main); box-shadow: none; }
        
        /* ç¯ç®± */
        .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.25s ease-out; }
        .lightbox.active { display: flex; opacity: 1; }
        .lightbox-content { max-width: 95%; max-height: 90vh; object-fit: contain; box-shadow: 0 0 30px rgba(0,0,0,0.5); border-radius: 4px; }
        .pdf-frame { width: 95%; height: 85vh; border: none; background: white; border-radius: 8px; }
        .btn-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.25); width: 44px; height: 44px; border-radius: 50%; border:none; color:white; font-size:24px; z-index: 5001; cursor: pointer; backdrop-filter: blur(10px); }

        /* Toast */
        #toast { position: fixed; top: 12px; left: 50%; transform: translateX(-50%) translateY(-20px); background: rgba(45, 55, 72, 0.95); color: white; padding: 10px 24px; border-radius: 30px; font-size: 14px; font-weight: 500; z-index: 6000; opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); backdrop-filter: blur(4px); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #toast.error { background: #E53E3E; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="lightbox" id="lightbox">
        <button class="btn-close" onclick="triggerClose()">Ã—</button>
        <img id="lb-img" class="lightbox-content" style="display:none" onclick="event.stopPropagation()">
        <video id="lb-video" class="lightbox-content" controls style="display:none" onclick="event.stopPropagation()"></video>
        <object id="lb-pdf" class="pdf-frame" type="application/pdf" style="display:none" onclick="event.stopPropagation()"></object>
    </div>

    <div class="modal" id="modal">
        <div class="card">
            <div class="hero-crop"><img src="./sloth.png" class="hero-img" alt="Logo"></div>
            <h2 style="margin:0; font-size:22px; color:var(--text-main)">é—ªç”µå¿«ä¼ </h2>
            <div id="qr-code" style="margin:24px auto; padding:10px; background:white; border-radius:16px; display:inline-block; min-height:100px;"></div>
            <div class="id-display" id="my-id">...</div>
            <input type="text" id="target-id" class="input-id" placeholder="è¾“å…¥å¯¹æ–¹ ID">
            <div id="scanner-box" style="display:none; height:240px; background:black; border-radius:16px; margin-bottom:20px; overflow:hidden;"><div id="reader" style="width:100%;height:100%"></div></div>
            <div style="display:flex; gap:12px;">
                <button class="btn-block btn-ghost" onclick="toggleScan()" style="flex:1">ğŸ“·</button>
                <button class="btn-block" onclick="connect()" style="flex:2">è¿æ¥</button>
            </div>
        </div>
    </div>

    <div class="navbar">
        <div class="brand">
            <div class="logo-box"><img src="./sloth.png" class="app-logo"></div>
            <span class="app-name">é—ªç”µå¿«ä¼ </span>
        </div>
        <div class="status-pill" id="status">ç¦»çº¿</div>
    </div>

    <div class="main-container">
        <div class="drag-overlay" id="drag-overlay">
            <div style="font-size:60px; margin-bottom:20px;">ğŸ“‚</div>
            <div style="font-size:18px;">æ¾æ‰‹ å‘é€æ–‡ä»¶</div>
        </div>

        <div class="drop-zone-wrapper">
            <div class="drop-card" id="drop-zone">
                <svg class="icon" style="width:36px;height:36px;margin-bottom:8px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                <span class="drop-label">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶ (æ”¯æŒæ–‡ä»¶å¤¹)</span>
            </div>
        </div>
        <div class="chat-scroll" id="chat-list">
            <div class="sys-notice">V22.0 è§†è§‰å¯¹æ¯”åº¦ä¼˜åŒ–ç‰ˆ</div>
        </div>
    </div>

    <div class="input-area-wrapper">
        <div class="input-bar">
            <button class="btn-circle" onclick="toggleInput()">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h2v2H6zm4 0h2v2h-2zm4 0h2v2h-2zm-8 4h2v2H6zm4 0h2v2h-2zm4 0h2v2h-2zm-8 4h12v2H6z"/></svg>
            </button>
            <button id="btn-voice" class="btn-voice">æŒ‰ä½ è¯´è¯</button>
            <input id="msg-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
            <button class="btn-circle" onclick="sendText()" id="btn-send" style="display:none; color:var(--primary);">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
        </div>
    </div>
    <input type="file" id="file-input" multiple style="display:none">

    <script>
        const App = { id: null, peer: null, conn: null, connected: false, queue: [], isSending: false };
        document.addEventListener('DOMContentLoaded', () => setTimeout(init, 100));

        function showToast(msg, type='normal') {
            const t = document.getElementById('toast');
            t.innerText = msg; t.className = type === 'error' ? 'error show' : 'show';
            setTimeout(() => t.className = '', 3000);
        }

        function init() {
            App.id = localStorage.getItem('sloth_v22') || (Math.floor(Math.random()*9000)+1000).toString();
            localStorage.setItem('sloth_v22', App.id);
            document.getElementById('my-id').innerText = App.id;
            const qr = document.getElementById("qr-code");
            if(qr && window.QRCode) new QRCode(qr, { text: App.id, width: 100, height: 100, colorDark: "#2B6CB0", colorLight: "#FFFFFF" });

            if(window.Peer) {
                App.peer = new Peer(App.id, { debug: 1 });
                App.peer.on('open', () => document.getElementById('status').innerText='ç­‰å¾…è¿æ¥');
                App.peer.on('connection', c => { if(confirm('è¿æ¥ ID: '+c.peer+'?')) setupConn(c); });
                App.peer.on('error', e => { console.error(e); document.getElementById('status').innerText='é‡è¿ä¸­...'; });
                setInterval(() => { if(App.conn && App.conn.open) App.conn.send({type:'ping'}); }, 3000);
            }
        }

        function setupConn(conn) {
            if(App.conn) App.conn.close(); App.conn = conn;
            conn.on('open', () => conn.send({ type: 'handshake' }));
            conn.on('data', handleData);
            conn.on('close', () => { App.connected=false; document.getElementById('status').innerText='å·²æ–­å¼€'; showToast('è¿æ¥æ–­å¼€', 'error'); });
        }
        function connect() { const t=document.getElementById('target-id').value.trim(); if(t) setupConn(App.peer.connect(t, {reliable:true})); }

        let Rx = { buf: [], size: 0, meta: null, lastLoaded: 0, lastTime: 0 };
        function handleData(data) {
            if (data.type) {
                if(data.type==='handshake'){ App.connected=true; document.getElementById('modal').style.display='none'; document.getElementById('status').innerText='å·²è¿æ¥'; document.getElementById('status').classList.add('online'); showToast('è¿æ¥æˆåŠŸ'); }
                else if(data.type==='text') addMsg(data.text, 'peer');
                else if(data.type==='file-start') { Rx={buf:[],size:0,meta:data,lastLoaded:0,lastTime:Date.now()}; createFileItem(data.id, data.name, data.size, 'peer', data.mime); }
                else if(data.type==='file-end') finishFile(data.id, Rx.meta.mime);
            } else {
                Rx.buf.push(data); Rx.size += data.byteLength;
                const now = Date.now();
                if(now - Rx.lastTime > 500) {
                    const speed = calcSpeed(Rx.size - Rx.lastLoaded, now - Rx.lastTime);
                    updateProgress(Rx.meta.id, Rx.size, Rx.meta.size, speed);
                    Rx.lastLoaded = Rx.size; Rx.lastTime = now;
                }
            }
        }
        function calcSpeed(bytes, ms) { return ms<=0?'':(bytes/ms*1000 > 1048576 ? (bytes/ms*1000/1048576).toFixed(1)+' MB/s' : (bytes/ms*1000/1024).toFixed(0)+' KB/s'); }

        const dragOverlay = document.getElementById('drag-overlay');
        const dropCard = document.getElementById('drop-zone');
        let dragCounter = 0;

        document.addEventListener('dragenter', e => { e.preventDefault(); dragCounter++; dragOverlay.classList.add('active'); });
        document.addEventListener('dragleave', e => { e.preventDefault(); dragCounter--; if(dragCounter===0) dragOverlay.classList.remove('active'); });
        document.addEventListener('dragover', e => e.preventDefault());
        
        document.addEventListener('drop', async e => {
            e.preventDefault(); dragCounter=0; dragOverlay.classList.remove('active'); dropCard.classList.remove('drag-active');
            const items = [...e.dataTransfer.items];
            let list = [];
            for(let i of items){
                const ent = i.webkitGetAsEntry ? i.webkitGetAsEntry() : null;
                if(ent) list = list.concat(await scanEntry(ent));
                else if(i.kind==='file') list.push(i.getAsFile());
            }
            if(list.length) enqueue(list);
            else showToast("æ— æ³•è¯†åˆ«æ–‡ä»¶", "error");
        });

        async function scanEntry(entry) {
            if (entry.isFile) return new Promise(r => entry.file(f => r([f])));
            if (entry.isDirectory) {
                const r = entry.createReader();
                const ents = await new Promise((res, rej) => r.readEntries(res, rej));
                let files = [];
                for (const sub of ents) files = files.concat(await scanEntry(sub));
                return files;
            }
            return [];
        }

        document.getElementById('drop-zone').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = e => enqueue(e.target.files);

        function enqueue(files) {
            if(!App.connected) return showToast('è¯·å…ˆè¿æ¥è®¾å¤‡', 'error');
            Array.from(files).forEach(f => { const id = 'f-'+Date.now()+Math.random().toString(36).substr(2); createFileItem(id, f.name, f.size, 'self', f.type); App.queue.push({f, id}); });
            process();
        }
        function process() { if(App.isSending || !App.queue.length) return; App.isSending=true; sendFile(App.queue.shift()); }
        function sendFile({f, id}) {
            App.conn.send({type:'file-start', id, name:f.name, size:f.size, mime:f.type});
            const reader = new FileReader(); let offset=0; let lastTime=Date.now(); let lastLoaded=0;
            const push = () => { if(App.conn.dataChannel.bufferedAmount > 65536) { setTimeout(push, 20); return; } const s = f.slice(offset, offset + 32768); reader.readAsArrayBuffer(s); };
            reader.onload = e => {
                App.conn.send(e.target.result); offset += e.target.result.byteLength;
                const now = Date.now();
                if(now - lastTime > 500 || offset >= f.size) {
                    const speed = calcSpeed(offset - lastLoaded, now - lastTime);
                    updateProgress(id, offset, f.size, speed);
                    lastLoaded = offset; lastTime = now;
                }
                if(offset < f.size) setTimeout(push, 0); else { App.conn.send({type:'file-end', id}); App.isSending=false; setTimeout(process, 100); }
            };
            push();
        }

        function createFileItem(id, name, size, who, mime) {
            const div = document.createElement('div'); div.className = `msg-row ${who}`; div.id = `msg-${id}`;
            let iconSvg = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>';
            div.innerHTML = `
                <div class="file-card">
                    <div class="file-inner">
                        <div class="thumb-box">${iconSvg}</div>
                        <div class="file-info">
                            <div class="file-name">${name}</div>
                            <div class="file-meta"><span>${(size/1024).toFixed(1)} KB</span> <span class="speed-tag"></span></div>
                            <div class="progress-bar"><div class="progress-fill"></div></div>
                        </div>
                    </div>
                    <button class="btn-preview">ğŸ‘ï¸</button>
                </div>`;
            document.getElementById('chat-list').append(div);
            document.getElementById('chat-list').scrollTop = 99999;
        }
        function updateProgress(id, cur, tot, speed) {
            const el = document.getElementById(`msg-${id}`);
            if(el) { el.querySelector('.progress-fill').style.width = (cur/tot*100)+'%'; if(speed) el.querySelector('.speed-tag').innerText = speed; }
        }
        function finishFile(id, mime) {
            const el = document.getElementById(`msg-${id}`); if(!el) return;
            el.querySelector('.progress-bar').style.display='none'; el.querySelector('.speed-tag').innerText='å®Œæˆ';
            const url = URL.createObjectURL(new Blob(Rx.buf, {type: mime})); 
            const filename = Rx.meta ? Rx.meta.name : 'file'; Rx.buf = [];
            const inner = el.querySelector('.file-inner'), thumbBox = el.querySelector('.thumb-box'), btnPreview = el.querySelector('.btn-preview');
            inner.onclick = () => { const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); };

            if (mime.includes('image')) {
                thumbBox.innerHTML = `<img src="${url}" class="thumb-img">`; btnPreview.style.display = 'flex';
                btnPreview.onclick = (e) => { e.stopPropagation(); openLightbox(url, 'img'); };
            } else if (mime.includes('video')) {
                const video = document.createElement('video'); video.src = url; video.currentTime = 1; video.className = 'thumb-img';
                thumbBox.innerHTML = ''; thumbBox.appendChild(video);
                btnPreview.innerHTML = 'â–¶'; btnPreview.style.display = 'flex';
                btnPreview.onclick = (e) => { e.stopPropagation(); openLightbox(url, 'video'); };
            } else if (mime.includes('pdf')) {
                btnPreview.innerHTML = 'ğŸ“„'; btnPreview.style.display = 'flex';
                btnPreview.onclick = (e) => { e.stopPropagation(); openLightbox(url, 'pdf'); };
            }
        }

        function openLightbox(url, type) {
            history.pushState({modal: 'lightbox'}, '', '#preview');
            const lb=document.getElementById('lightbox'), img=document.getElementById('lb-img'), vid=document.getElementById('lb-video'), pdf=document.getElementById('lb-pdf');
            img.style.display='none'; vid.style.display='none'; pdf.style.display='none';
            lb.classList.add('active');
            if(type==='img') { img.src=url; img.style.display='block'; }
            else if(type==='video') { vid.src=url; vid.style.display='block'; vid.play(); }
            else if(type==='pdf') { pdf.data=url; pdf.style.display='block'; }
        }
        window.addEventListener('popstate', () => {
            const lb = document.getElementById('lightbox'); lb.classList.remove('active');
            document.getElementById('lb-video').pause(); document.getElementById('lb-pdf').data = '';
        });
        window.triggerClose = () => history.back();

        const bVoice=document.getElementById('btn-voice'); let mRec, chunks=[];
        const startR=async e=>{e.preventDefault();if(!App.connected)return;try{const s=await navigator.mediaDevices.getUserMedia({audio:true});mRec=new MediaRecorder(s);chunks=[];mRec.ondataavailable=e=>chunks.push(e.data);mRec.onstop=()=>enqueue([new File([new Blob(chunks)],"voice.webm",{type:'audio/webm'})]);mRec.start();bVoice.classList.add('recording');bVoice.innerText="æ¾å¼€ å‘é€";}catch(e){showToast("éº¦å…‹é£é”™è¯¯", 'error');}};
        const stopR=e=>{e.preventDefault();if(mRec)mRec.stop();bVoice.classList.remove('recording');bVoice.innerText="æŒ‰ä½ è¯´è¯";}
        ['touchstart','mousedown'].forEach(k=>bVoice.addEventListener(k,startR)); ['touchend','mouseup'].forEach(k=>bVoice.addEventListener(k,stopR));
        
        window.toggleInput=()=>{
            const t=document.getElementById('msg-input'), v=document.getElementById('btn-voice'), s=document.getElementById('btn-send');
            if(t.style.display==='none'){ t.style.display='block'; v.style.display='none'; s.style.display='block'; t.focus(); } 
            else { t.style.display='none'; v.style.display='block'; s.style.display='none'; }
        };
        window.sendText=()=>{const v=document.getElementById('msg-input').value;if(v){App.conn.send({type:'text',text:v});addMsg(v,'self');document.getElementById('msg-input').value='';}};
        function addMsg(t,w){const d=document.createElement('div');d.className=`msg-row ${w}`;d.innerHTML=`<div class="bubble">${t}</div>`;document.getElementById('chat-list').append(d);document.getElementById('chat-list').scrollTop=99999;}
        let qr; window.toggleScan=()=>{const s=document.getElementById('scanner-box');if(s.style.display==='block'){s.style.display='none';if(qr)qr.stop();}else{s.style.display='block';qr=new Html5Qrcode("reader");qr.start({facingMode:"environment"},{fps:10},t=>{document.getElementById('target-id').value=t;toggleScan();});}};
    </script>
</body>
</html>
