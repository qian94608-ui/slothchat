<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PepeNet PWA</title>
    
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="apple-touch-icon" href="./icon.png">
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* --- 1. åŸºç¡€é‡ç½® & Pepe é£æ ¼ --- */
        :root { --pepe-green: #59BC10; --pepe-dark: #46960C; --bg: #F2F2F7; --danger: #FF3B30; --text: #333; }
        body { margin: 0; padding: 0; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        * { box-sizing: border-box; user-select: none; }
        input { user-select: auto; }
        .hidden { display: none !important; }

        /* --- 2. å¤´éƒ¨å¯¼èˆª (Fixed Top) --- */
        .defi-header { 
            position: fixed; top: 0; left: 0; width: 100%; height: 60px; 
            background: #fff; z-index: 1000; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center; padding: 0 15px;
        }
        .user-pill { display: flex; align-items: center; gap: 10px; background: #f5f5f5; padding: 4px 12px; border-radius: 20px; border: 1px solid #ddd; }
        .header-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: contain; background: #fff; border: 1px solid #eee; }
        .add-btn { background: #eee; padding: 6px 12px; border-radius: 15px; font-weight: bold; font-size: 14px; cursor: pointer; }

        /* --- 3. è§†å›¾å®¹å™¨ (ç‰©ç†éš”ç¦») --- */
        /* ä¸»é¡µ */
        #view-home { 
            width: 100%; height: 100vh; overflow-y: auto; 
            padding-top: 70px; /* é¿å¼€å¤´éƒ¨ */
            padding-bottom: 20px;
        }
        
        /* èŠå¤©é¡µ (é»˜è®¤å³ä¾§éšè—) */
        #view-chat { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #F2F2F7; z-index: 2000; 
            transform: translateX(100%); 
            transition: transform 0.25s ease-out; 
            display: flex; flex-direction: column; 
        }
        #view-chat.active { transform: translateX(0); }

        /* --- 4. èŠå¤©å¸ƒå±€ --- */
        #messages-container {
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            padding: 15px; 
            padding-bottom: 120px !important; /* â˜… åº•éƒ¨é˜²é®æŒ¡æ ¸å¿ƒ â˜… */
            display: flex; flex-direction: column; gap: 12px;
            margin-top: 60px; /* é¿å¼€å¤´éƒ¨ */
        }

        .chat-footer { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 70px;
            background: #fff; border-top: 1px solid #eee; z-index: 3000; 
            display: flex; align-items: center; padding: 0 8px; gap: 6px;
        }

        /* --- 5. åº•éƒ¨æ§ä»¶ --- */
        .icon-btn { 
            width: 42px; height: 42px; border-radius: 50%; background: #f2f2f2; 
            border: 1px solid #ddd; font-size: 20px; flex-shrink: 0; 
            display: flex; justify-content: center; align-items: center; cursor: pointer; color: #555;
        }

        .input-zone { flex: 1; position: relative; height: 42px; display: flex; align-items: center; min-width: 0; }
        
        /* æ–‡æœ¬æ¡† */
        #chat-input { 
            width: 100%; height: 100%; border-radius: 20px; background: #f9f9f9; 
            border: 1px solid #ddd; padding: 0 15px; outline: none; font-size: 16px; color: #000;
        }
        
        /* è¯­éŸ³é•¿æŒ‰æ¡ */
        #voice-bar {
            width: 100%; height: 100%; border-radius: 20px; background: var(--danger); 
            color: #fff; font-weight: bold; display: none; /* é»˜è®¤éšè— */
            justify-content: center; align-items: center; cursor: pointer; font-size: 14px;
        }
        #voice-bar.recording { animation: pulse 1s infinite; background: #cc0000; }

        /* å‘é€æŒ‰é’® (å¼ºåˆ¶æœ€é«˜å±‚çº§) */
        #send-btn { 
            width: 44px; height: 44px; border-radius: 20px; background: var(--pepe-green); 
            color: #fff; border: none; font-weight: bold; flex-shrink: 0; 
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            z-index: 3001; /* å¿…ç‚¹ */ font-size: 16px;
        }
        #send-btn:active { transform: scale(0.95); }

        /* --- 6. æ¶ˆæ¯æ°”æ³¡ UI --- */
        .msg-row { display: flex; width: 100%; }
        .msg-row.self { justify-content: flex-end; }
        .msg-row.other { justify-content: flex-start; }
        
        .bubble { 
            padding: 10px 14px; border-radius: 16px; max-width: 75%; 
            position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
            font-size: 15px; line-height: 1.4; word-break: break-word; 
        }
        .msg-row.self .bubble { background: var(--pepe-green); color: #fff; border-bottom-right-radius: 4px; }
        .msg-row.other .bubble { background: #fff; color: #000; border: 1px solid #eee; border-bottom-left-radius: 4px; }
        
        .bubble.clean { background: transparent !important; padding: 0 !important; box-shadow: none !important; border: none !important; }

        /* å³æ—¶è¯­éŸ³æ’­æ”¾å™¨ */
        .voice-bubble { display: flex; align-items: center; gap: 10px; min-width: 160px; padding: 5px 0; }
        .vp-btn { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.3); display: flex; justify-content: center; align-items: center; cursor: pointer; color: inherit; }
        .msg-row.other .vp-btn { background: #f0f0f0; border-color: #ddd; color: var(--pepe-green); }
        
        /* éŸ³é¢‘/æ–‡ä»¶å¡ç‰‡ */
        .file-card { display: flex; align-items: center; gap: 10px; background: #fff; padding: 12px; border-radius: 12px; width: 220px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-decoration: none; color: #333 !important; cursor: pointer; }
        .file-icon { font-size: 24px; flex-shrink: 0; }
        .file-info { flex: 1; overflow: hidden; }
        .file-name { font-weight: bold; font-size: 13px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-type { font-size: 10px; color: #999; font-weight: 700; margin-top: 3px; }

        .thumb-img { max-width: 200px; border-radius: 12px; display: block; border: 1px solid #eee; }
        .sticker-img { width: 100px; height: 100px; object-fit: contain; cursor: pointer; }

        /* --- 7. æ‹¨å·ç›˜ & æ¨¡æ€æ¡† --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999999; display: flex; justify-content: center; align-items: center; }
        .numpad-box { background: #fff; padding: 20px; border-radius: 20px; width: 300px; text-align: center; }
        .dial-screen { font-size: 36px; font-weight: 900; color: var(--pepe-green); border-bottom: 2px solid #eee; margin-bottom: 20px; height: 50px; line-height: 50px; }
        .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .num-btn { height: 60px; background: #fff; border: 1px solid #eee; border-radius: 12px; font-size: 24px; font-weight: bold; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #333; box-shadow: 0 3px 0 #eee; }
        .num-btn:active { transform: translateY(3px); box-shadow: none; }
        .num-btn.ok { background: var(--pepe-green); color: #fff; border-color: var(--pepe-dark); box-shadow: 0 3px 0 var(--pepe-dark); }
        .num-btn.clr { color: var(--danger); }
        
        /* åˆ—è¡¨ */
        .k-list-item { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; }
        .k-list-item:active { background: #f9f9f9; }
        .unread-dot { width: 10px; height: 10px; background: var(--danger); border-radius: 50%; }

        /* è¿›åº¦æ¡ */
        .progress-wrapper { background: #fff; padding: 10px; border-radius: 10px; border: 2px solid var(--pepe-green); width: 200px; }
        .msg-row.self .progress-wrapper { background: var(--pepe-dark); color: #fff; border-color: #fff; }
        .progress-fill { height: 6px; width: 0%; background: var(--pepe-green); transition: width 0.1s; }
        .msg-row.self .progress-fill { background: #fff; }

        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.02);} }
    </style>
</head>
<body>

    <div id="view-home">
        <div class="defi-header">
            <div class="user-pill" onclick="editMyName()">
                <img id="my-avatar" class="header-avatar" src="./icon.png" onerror="this.src='https://api.dicebear.com/7.x/notionists/svg?seed=fallback'">
                <span id="my-nickname">Anon</span>
            </div>
            <div class="add-btn" onclick="showDialpad()">+ Add ID</div>
        </div>

        <div class="id-card">
            <div style="font-size:12px; color:#999; margin-bottom:5px;">MY ID</div>
            <div id="my-id-display" class="my-id" style="font-size:36px; font-weight:900; color:#59BC10;">....</div>
            <div id="qrcode" style="display:flex; justify-content:center; margin-top:20px;"></div>
        </div>

        <div id="friends-list"></div>
    </div>

    <div id="view-chat">
        <div class="defi-header">
            <div class="icon-btn" onclick="goBack()">â¬…</div>
            <div id="chat-title" style="font-weight:bold; font-size:16px;">Chat</div>
            <div style="width:40px;"></div>
        </div>

        <div id="messages-container"></div>

        <div class="chat-footer">
            <div class="icon-btn" onclick="toggleStickers()">ğŸ˜Š</div>
            <div class="input-zone">
                <input type="text" id="chat-input" placeholder="Type...">
                <div id="voice-bar">HOLD TO SPEAK</div>
            </div>
            <div class="icon-btn" onclick="document.getElementById('file-input').click()">ğŸ“</div>
            <div class="icon-btn" id="mode-btn" onclick="toggleMode()">ğŸ¤</div>
            <div id="send-btn" onclick="handleSend()">â¤</div>
        </div>
    </div>

    <div id="dialpad-modal" class="modal-overlay hidden">
        <div class="numpad-box">
            <div id="dial-display" class="dial-screen">____</div>
            <div class="numpad-grid">
                <div class="num-btn" onclick="dial(1)">1</div><div class="num-btn" onclick="dial(2)">2</div><div class="num-btn" onclick="dial(3)">3</div>
                <div class="num-btn" onclick="dial(4)">4</div><div class="num-btn" onclick="dial(5)">5</div><div class="num-btn" onclick="dial(6)">6</div>
                <div class="num-btn" onclick="dial(7)">7</div><div class="num-btn" onclick="dial(8)">8</div><div class="num-btn" onclick="dial(9)">9</div>
                <div class="num-btn clr" onclick="dial('C')">C</div><div class="num-btn" onclick="dial(0)">0</div>
                <div class="num-btn ok" onclick="dial('OK')">ğŸ¤</div>
            </div>
            <div style="margin-top:15px; color:#999; cursor:pointer;" onclick="closeModal()">Cancel</div>
        </div>
    </div>

    <div id="preview-modal" class="modal-overlay hidden">
        <div style="position:relative; width:100%; height:100%; display:flex; justify-content:center; align-items:center;">
            <button onclick="closePreview()" style="position:absolute; top:40px; right:20px; color:#fff; background:none; border:none; font-size:30px;">âœ•</button>
            <div id="preview-content"></div>
        </div>
    </div>

    <input type="file" id="file-input" style="display:none;" multiple onchange="handleFiles(this.files)">
    
    <div id="sticker-panel" class="hidden" style="position:fixed; bottom:70px; width:100%; background:#fff; padding:10px; border-top:1px solid #eee; display:grid; grid-template-columns:repeat(4,1fr); gap:10px; z-index:600;">
        <div id="sticker-grid" style="display:contents;"></div>
    </div>

    <audio id="msg-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

    <script>
        // --- 1. é…ç½®ä¸çŠ¶æ€ ---
        const SERVER_URL = 'https://wojak-backend.onrender.com';
        const DB_KEY = 'pepe_v81_pwa_fix';
        const CHUNK_SIZE = 12 * 1024;
        
        let db, socket, activeChatId = null;
        let activeDownloads = {}, isSending = false, cancelFlag = {}, uploadQueue = [];
        let isVoiceMode = false, dialInput = "", globalAudio = null;

        // --- 2. åˆå§‹åŒ– ---
        try {
            db = JSON.parse(localStorage.getItem(DB_KEY));
            if(!db || !db.profile) throw new Error();
        } catch {
            db = { profile: { id: String(Math.floor(1000+Math.random()*9000)), nickname: 'Anon' }, friends: [], history: {} };
            localStorage.setItem(DB_KEY, JSON.stringify(db));
        }
        const saveDB = () => localStorage.setItem(DB_KEY, JSON.stringify(db));
        const MY_ID = db.profile.id;

        function init() {
            document.getElementById('my-id-display').innerText = MY_ID;
            document.getElementById('my-nickname').innerText = db.profile.nickname;
            new QRCode(document.getElementById("qrcode"), {text:MY_ID, width:120, height:120, colorDark:"#59BC10", colorLight:"#ffffff"});
            
            renderFriends();
            setupStickers();
            initNetwork();
            
            // â˜… PWA: æ³¨å†Œ Service Worker â˜…
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(() => console.log('SW Registered'))
                    .catch(e => console.log('SW Fail', e));
            }

            // ç»‘å®šå½•éŸ³äº‹ä»¶
            const vb = document.getElementById('voice-bar');
            vb.addEventListener('mousedown', startRec);
            vb.addEventListener('mouseup', stopRec);
            vb.addEventListener('touchstart', startRec);
            vb.addEventListener('touchend', stopRec);
            
            // ç»‘å®šå›è½¦
            document.getElementById('chat-input').addEventListener('keydown', (e) => {
                if(e.key === 'Enter') handleSend();
            });
        }

        // --- 3. æ ¸å¿ƒäº¤äº’é€»è¾‘ ---

        // æ‹¨å·ç›˜
        window.showDialpad = () => {
            document.getElementById('dialpad-modal').classList.remove('hidden');
            dialInput = ""; document.getElementById('dial-display').innerText = "____";
        };
        window.closeModal = () => document.getElementById('dialpad-modal').classList.add('hidden');
        
        window.dial = (k) => {
            const d = document.getElementById('dial-display');
            if(k === 'C') { dialInput = ""; d.innerText = "____"; return; }
            if(k === 'OK') {
                if(dialInput.length === 4) {
                    if(dialInput === MY_ID) { alert("No Self-Chat"); return; }
                    const target = dialInput;
                    if(!db.friends.find(f=>f.id===target)) {
                        db.friends.push({id:target, addedAt:Date.now(), unread:false});
                        saveDB(); renderFriends();
                    }
                    window.closeModal();
                    openChat(target); // â˜… ç«‹å³è·³è½¬ â˜…
                } else alert("Enter 4 Digits");
                return;
            }
            if(dialInput.length < 4) { dialInput += k; d.innerText = dialInput.padEnd(4, '_'); }
        };

        // èŠå¤©è·³è½¬
        window.openChat = (id) => {
            activeChatId = id;
            document.getElementById('chat-title').innerText = `User ${id}`;
            document.getElementById('view-chat').classList.add('active'); // æ»‘å…¥
            
            // é‡ç½®è¾“å…¥
            isVoiceMode = false; updateInputUI();
            
            // æ¸²æŸ“æ¶ˆæ¯
            const box = document.getElementById('messages-container');
            box.innerHTML = '';
            const msgs = db.history[id] || [];
            msgs.forEach(m => appendMsg(m));
            box.scrollTop = box.scrollHeight;
        };

        window.goBack = () => {
            document.getElementById('view-chat').classList.remove('active'); // æ»‘å‡º
            activeChatId = null;
            renderFriends();
        };

        // å‘é€é€»è¾‘
        window.handleSend = () => {
            const input = document.getElementById('chat-input');
            if(input.value.trim()) {
                sendData('text', input.value);
                input.value = '';
            }
        };

        function sendData(type, content) {
            if(socket && socket.connected) socket.emit('send_private', { targetId: activeChatId, content, type });
            const m = { type, content, isSelf: true, ts: Date.now() };
            saveMsg(activeChatId, m);
            appendMsg(m);
        }

        // --- 4. UI æ¸²æŸ“ ---
        function renderFriends() {
            const list = document.getElementById('friends-list');
            list.innerHTML = '';
            db.friends.forEach(f => {
                const div = document.createElement('div');
                div.className = 'k-list-item';
                div.onclick = () => openChat(f.id);
                div.innerHTML = `
                    <img src="https://api.dicebear.com/7.x/notionists/svg?seed=${f.id}" style="width:40px;height:40px;border-radius:10px;">
                    <div style="flex:1;font-weight:bold;">${f.alias || f.id}</div>
                    ${f.unread ? '<div class="unread-dot"></div>' : ''}
                `;
                list.appendChild(div);
            });
        }

        function appendMsg(msg) {
            const box = document.getElementById('messages-container');
            const div = document.createElement('div');
            div.className = `msg-row ${msg.isSelf ? 'self' : 'other'}`;
            let html = '';
            
            if(msg.type === 'text') html = `<div class="bubble">${msg.content}</div>`;
            else if(msg.type === 'sticker') html = `<div class="bubble clean"><img src="${msg.content}" class="sticker-img"></div>`;
            else if(msg.type === 'voice') {
                html = `<div class="bubble">
                    <div class="audio-player">
                        <div class="play-icon" onclick="toggleAudio(this, '${msg.content}')" style="cursor:pointer;font-size:20px;">â–¶</div>
                        <div style="font-size:12px;">Voice Note</div>
                    </div>
                </div>`;
            }
            else if(msg.type === 'file') {
                // éŸ³é¢‘æ–‡ä»¶ vs æ™®é€šæ–‡ä»¶
                if(msg.fileName && msg.fileName.match(/\.(mp3|wav|ogg|m4a)$/i)) {
                     html = `<div class="bubble clean">
                        <div class="file-card" onclick="previewMedia('${msg.content}','audio')">
                            <div style="font-size:24px">ğŸµ</div>
                            <div style="flex:1;overflow:hidden;">
                                <div style="font-weight:bold;font-size:13px;">${msg.fileName}</div>
                                <div style="font-size:10px;color:#999;">CLICK TO PLAY</div>
                            </div>
                        </div>
                     </div>`;
                } else {
                    html = `<div class="bubble clean">
                        <a class="file-card" href="${msg.content}" download="${msg.fileName}">
                            <div style="font-size:24px">ğŸ“„</div>
                            <div style="flex:1;overflow:hidden;">
                                <div style="font-weight:bold;font-size:13px;">${msg.fileName}</div>
                                <div style="font-size:10px;color:#999;">CLICK SAVE</div>
                            </div>
                        </a>
                     </div>`;
                }
            }
            else if(msg.type === 'image') html = `<div class="bubble clean"><img src="${msg.content}" class="thumb-img" onclick="previewMedia('${msg.content}','image')"></div>`;
            else if(msg.type === 'video') html = `<div class="bubble clean"><video src="${msg.content}#t=0.1" class="thumb-img" onclick="previewMedia('${msg.content}','video')"></video></div>`;

            div.innerHTML = html;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- 5. è¾…åŠ©åŠŸèƒ½ ---
        window.toggleMode = () => {
            isVoiceMode = !isVoiceMode;
            updateInputUI();
        };

        function updateInputUI() {
            const input = document.getElementById('chat-input');
            const vBar = document.getElementById('voice-bar');
            const sBtn = document.getElementById('send-btn');
            const mBtn = document.getElementById('mode-switch-btn');
            
            if(isVoiceMode) {
                input.style.display = 'none';
                sBtn.style.display = 'none';
                vBar.style.display = 'flex';
                mBtn.innerText = 'âŒ¨ï¸';
            } else {
                input.style.display = 'block';
                sBtn.style.display = 'flex';
                vBar.style.display = 'none';
                mBtn.innerText = 'ğŸ¤';
            }
        }

        window.toggleAudio = (el, url) => {
            if(!globalAudio) globalAudio = new Audio();
            if(globalAudio.src !== url) { globalAudio.src = url; globalAudio.play(); el.innerText='â¸'; }
            else { 
                if(globalAudio.paused) { globalAudio.play(); el.innerText='â¸'; }
                else { globalAudio.pause(); el.innerText='â–¶'; }
            }
            globalAudio.onended = () => el.innerText='â–¶';
        };

        window.previewMedia = (u, t) => {
            const m = document.getElementById('preview-modal'); m.classList.remove('hidden');
            const c = document.getElementById('preview-content');
            if(t==='image') c.innerHTML = `<img src="${u}" style="max-width:100%">`;
            else if(t==='video') c.innerHTML = `<video src="${u}" controls autoplay style="max-width:100%"></video>`;
            else if(t==='audio') c.innerHTML = `<audio src="${u}" controls autoplay style="width:80%"></audio>`;
        };
        window.closePreview = () => document.getElementById('preview-modal').classList.add('hidden');

        // æ–‡ä»¶å¤„ç†
        window.triggerFile = () => document.getElementById('file-input').click();
        window.handleFiles = (files) => {
            Array.from(files).forEach(f => addToQueue(f));
        };
        
        function addToQueue(file, isVoice=false) { uploadQueue.push({file, isVoice}); processQueue(); }
        function processQueue() { if(isSending || uploadQueue.length===0) return; const item=uploadQueue.shift(); sendFileChunked(item.file, item.isVoice); }
        
        function sendFileChunked(file, isVoice) {
            isSending = true;
            const fileId = Date.now() + '-' + Math.random().toString(36).substr(2,5);
            // è¿›åº¦æ¡
            const box = document.getElementById('messages-container');
            const div = document.createElement('div'); div.className='msg-row self'; div.id=`prog-${fileId}`;
            div.innerHTML = `<div class="bubble clean"><div class="progress-wrapper"><div style="font-weight:bold">${file.name}</div><div class="progress-fill" id="bar-${fileId}"></div></div></div>`;
            box.appendChild(div); box.scrollTop = box.scrollHeight;

            let offset = 0;
            const total = file.size;
            
            const readNext = () => {
                if(offset >= total) {
                    socket.emit('send_private', { targetId: activeChatId, type: 'tunnel_file_packet', content: JSON.stringify({ subType:'end', fileId }) });
                    // æœ¬åœ°å®Œæˆ
                    const m = { type: 'file', content: URL.createObjectURL(file), fileName: file.name, isSelf: true, ts: Date.now() };
                    // ç±»å‹ä¿®æ­£
                    if(isVoice) m.type='voice';
                    else if(file.type.startsWith('image')) m.type='image';
                    else if(file.type.startsWith('video')) m.type='video';
                    
                    document.getElementById(`prog-${fileId}`).remove();
                    saveMsg(activeChatId, m);
                    isSending=false; setTimeout(processQueue, 100);
                    return;
                }
                const chunk = file.slice(offset, offset + CHUNK_SIZE);
                const r = new FileReader();
                r.onload = e => {
                    const b64 = e.target.result.split(',')[1];
                    socket.emit('send_private', {
                         targetId: activeChatId, type: 'tunnel_file_packet',
                         content: JSON.stringify({
                             subType:'chunk', fileId, data:b64, 
                             fileName:file.name, fileType:file.type, totalSize:total, isVoice 
                         })
                    });
                    offset += chunk.size;
                    const bar = document.getElementById(`bar-${fileId}`);
                    if(bar) bar.style.width = `${Math.floor((offset/total)*100)}%`;
                    setTimeout(readNext, 30);
                };
                r.readAsDataURL(chunk);
            };
            readNext();
        }

        function saveMsg(fid, msg) {
            if(!db.history[fid]) db.history[fid] = [];
            db.history[fid].push(msg);
            
            let f = db.friends.find(x => x.id === fid);
            if(!f) { f = {id:fid, addedAt:Date.now(), unread:true}; db.friends.push(f); }
            else if(activeChatId !== fid) { f.unread = true; }
            
            saveDB(); renderFriends();
            if(activeChatId === fid) appendMsg(msg);
            else document.getElementById('msg-sound').play().catch(()=>{});
        }

        function initNetwork() {
            socket = io(SERVER_URL, {transports:['websocket']});
            socket.on('connect', () => socket.emit('register', MY_ID));
            socket.on('receive_msg', (msg) => {
                if(msg.type === 'tunnel_file_packet') {
                    const p = JSON.parse(msg.content);
                    if(p.subType === 'chunk') {
                       if(!activeDownloads[p.fileId]) { activeDownloads[p.fileId] = {chunks:[], name:p.fileName, type:p.fileType, isVoice:p.isVoice, total:p.totalSize, cur:0}; }
                       activeDownloads[p.fileId].chunks.push(p.data);
                       activeDownloads[p.fileId].cur += Math.floor(p.data.length * 0.75);
                       // ç®€æ˜“æ¥æ”¶è¿›åº¦æ¡... (ç•¥ï¼Œä¿è¯ä¸æŠ¥é”™)
                    } else if(p.subType === 'end') {
                       const dl = activeDownloads[p.fileId];
                       if(dl) {
                           const b = atob(dl.chunks.join(''));
                           const a = new Uint8Array(b.length);
                           for(let i=0;i<b.length;i++) a[i]=b.charCodeAt(i);
                           const blob = new Blob([a], {type:dl.type});
                           const url = URL.createObjectURL(blob);
                           
                           let type = 'file';
                           if(dl.isVoice) type='voice';
                           else if(dl.type.startsWith('image')) type='image';
                           else if(dl.type.startsWith('video')) type='video';
                           
                           const m = { type, content: url, fileName: dl.name, isSelf: false, ts: Date.now() };
                           saveMsg(msg.from, m);
                           delete activeDownloads[p.fileId];
                       }
                    }
                } else {
                    saveMsg(msg.from, {type:msg.type, content:msg.content, isSelf:false, ts:Date.now()});
                }
            });
        }
        
        function setupStickers() {
            const g = document.getElementById('sticker-grid');
            for(let i=1;i<=12;i++) {
                const img = document.createElement('img'); img.src=`./s${i}.png`;
                img.style.cssText="width:60px;height:60px;object-fit:contain;cursor:pointer";
                img.onclick=()=>{ sendData('sticker', img.src); document.getElementById('sticker-panel').classList.add('hidden'); };
                g.appendChild(img);
            }
        }
        window.toggleStickers = () => document.getElementById('sticker-panel').classList.toggle('hidden');
        window.editMyName = () => { const n=prompt("Name",db.profile.nickname); if(n){db.profile.nickname=n;saveDB();init();} };
        window.editContactAlias = (fid) => { const n=prompt("Alias"); if(n){db.friends.find(f=>f.id===fid).alias=n;saveDB();renderFriends();} };

        // å½•éŸ³
        let rec, chunks;
        const startRec = async() => { try{ const s=await navigator.mediaDevices.getUserMedia({audio:true}); rec=new MediaRecorder(s); chunks=[]; rec.ondataavailable=e=>chunks.push(e.data); rec.onstop=()=>{ const f=new File([new Blob(chunks)], "voice.wav", {type:"audio/wav"}); addToQueue(f, true); }; rec.start(); document.getElementById('voice-bar').innerText = "RECORDING..."; document.getElementById('voice-bar').classList.add('recording'); }catch(e){alert("Mic Error");} };
        const stopRec = () => { if(rec) { rec.stop(); document.getElementById('voice-bar').innerText = "HOLD TO SPEAK"; document.getElementById('voice-bar').classList.remove('recording'); } };

        // å¯åŠ¨
        init();

    </script>
</body>
</html>
